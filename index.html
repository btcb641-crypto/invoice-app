<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title>
    
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Tajawal', sans-serif; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); min-height: 100vh; margin: 0; padding: 0; }
        
        .sidebar { background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; box-shadow: -5px 0 20px rgba(0,0,0,0.3); transition: transform 0.3s ease; }
        .nav-btn { transition: all 0.3s ease; border-right: 3px solid transparent; background: transparent; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); border-right-color: #fbbf24; }
        .nav-btn.active { background: linear-gradient(90deg, rgba(251,191,36,0.2) 0%, transparent 100%); }
        
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group label { position: absolute; top: -10px; right: 12px; background: white; padding: 0 8px; font-size: 12px; color: #6b7280; z-index: 1; }
        .input-group input, .input-group select { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.3s; background: white; }
        .input-group input:focus, .input-group select:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        
        .btn { padding: 10px 16px; border-radius: 10px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; cursor: pointer; border: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-gray { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }
        .btn-teal { background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* ===== ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© A4 ===== */
        .invoice-preview {
            background: white;
            width: 210mm;
            min-height: 297mm;
            max-width: 100%;
            margin: 0 auto;
            padding: 15mm 20mm;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            font-family: "Times New Roman", serif;
            font-size: 13px;
            color: #000;
            line-height: 1.4;
        }
        
        .invoice-header {
            text-align: center;
            padding: 10px 15px;
            margin-bottom: 12px;
            border: 2px solid #000;
            border-radius: 0;
        }
        
        .seller-name {
            font-family: 'Amiri', serif;
            font-size: 26px;
            font-weight: 700;
            color: #000;
            direction: rtl;
            margin-bottom: 2px;
        }
        
        .invoice-table { width: 100%; border-collapse: collapse; }
        .invoice-table th, .invoice-table td { border: 1px solid #000; padding: 6px 8px; }
        .invoice-table th { background: #e8e8e8; font-weight: bold; text-align: center; font-size: 12px; }
        
        .page-content { display: none; }
        .page-content.active { display: block; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 20px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        
        .mobile-menu-btn { display: none; position: fixed; top: 15px; right: 15px; z-index: 1001; background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; border: none; border-radius: 12px; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; justify-content: center; }
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998; }
        .overlay.active { display: block; }
        .main-content { margin-right: 256px; padding: 24px; min-height: 100vh; }
        
        /* PDF Preview Modal */
        .pdf-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1a1a2e; z-index: 3000; flex-direction: column; }
        .pdf-modal.active { display: flex; }
        .pdf-toolbar { background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .pdf-toolbar h3 { color: white; font-size: 16px; margin: 0; }
        .pdf-toolbar-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .pdf-content { flex: 1; overflow: auto; padding: 20px; display: flex; justify-content: center; align-items: flex-start; background: #4a5568; }
        .pdf-frame {
            background: white;
            width: 210mm;
            min-height: 297mm;
            max-width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            padding: 15mm 20mm;
            font-family: "Times New Roman", serif;
            font-size: 13px;
            color: #000;
            line-height: 1.4;
        }
        
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-box { background: white; padding: 30px 50px; border-radius: 15px; text-align: center; }
        .loading-icon { font-size: 40px; margin-bottom: 15px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        @media (max-width: 1024px) {
            .sidebar { position: fixed; right: -280px; top: 0; width: 260px; z-index: 999; }
            .sidebar.open { right: 0; }
            .mobile-menu-btn { display: flex; }
            .main-content { margin-right: 0; padding: 70px 15px 15px; }
        }
        
        @media (max-width: 640px) {
            .main-content { padding: 65px 10px 10px; }
            .card { border-radius: 12px; padding: 15px !important; }
            .stats-card { padding: 15px; }
            .stats-card .text-3xl { font-size: 1.5rem !important; }
            .stats-card .text-4xl { font-size: 2rem !important; }
            .btn { padding: 8px 12px; font-size: 12px; gap: 4px; }
            .btn-sm { padding: 5px 8px; font-size: 11px; }
            .input-group input, .input-group select { padding: 10px 12px; font-size: 14px; }
            .input-group label { font-size: 10px; }
            table { font-size: 12px; }
            table th, table td { padding: 6px 4px !important; }
            .invoice-preview { padding: 10px; font-size: 11px; min-height: auto; width: 100%; }
            .invoice-preview .seller-name { font-size: 20px; }
            .invoice-table th, .invoice-table td { padding: 4px 2px; font-size: 10px; }
            .flex.gap-2.mt-3 { flex-wrap: wrap; gap: 5px !important; }
            .pdf-toolbar { padding: 10px; }
            .pdf-toolbar h3 { font-size: 14px; width: 100%; text-align: center; }
            .pdf-toolbar-buttons { width: 100%; justify-content: center; }
            .pdf-content { padding: 10px; }
            .pdf-frame { width: 100%; padding: 10px; min-height: auto; }
        }
        
        @media (max-width: 380px) {
            .mobile-menu-btn { width: 45px; height: 45px; font-size: 20px; top: 10px; right: 10px; }
            .main-content { padding: 60px 8px 8px; }
            .btn { padding: 6px 10px; font-size: 11px; }
        }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 210mm; }
            @page { size: A4; margin: 10mm; }
        }
    </style>
</head>

<body>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
    <div class="overlay" id="overlay" onclick="closeMobileMenu()"></div>
    
    <!-- Edit Client Modal -->
    <div class="modal" id="editClientModal">
        <div class="modal-content">
            <h3 class="font-bold text-lg mb-4">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
            <input type="hidden" id="editClientId">
            <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="editClientName"></div>
            <div class="input-group"><label>Ø§Ù„Ù†Ø´Ø§Ø·</label><input type="text" id="editClientJob"></div>
            <div class="input-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="editClientAddress"></div>
            <div class="input-group"><label>RC NÂ°</label><input type="text" id="editClientRC"></div>
            <div class="input-group"><label>IF NÂ°</label><input type="text" id="editClientIF"></div>
            <div class="input-group"><label>ART NÂ°</label><input type="text" id="editClientART"></div>
            <div class="flex gap-3 mt-4">
                <button onclick="saveEditedClient()" class="btn btn-success flex-1">âœ… Ø­ÙØ¸</button>
                <button onclick="closeModal('editClientModal')" class="btn btn-gray flex-1">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Product Modal -->
    <div class="modal" id="editProductModal">
        <div class="modal-content">
            <h3 class="font-bold text-lg mb-4">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h3>
            <input type="hidden" id="editProductId">
            <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="editProductName"></div>
            <div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="editProductPrice"></div>
            <div class="input-group"><label>Ø§Ù„ÙˆØ­Ø¯Ø©</label><input type="text" id="editProductUnit"></div>
            <div class="flex gap-3 mt-4">
                <button onclick="saveEditedProduct()" class="btn btn-success flex-1">âœ… Ø­ÙØ¸</button>
                <button onclick="closeModal('editProductModal')" class="btn btn-gray flex-1">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Preview Modal -->
    <div class="pdf-modal" id="pdfModal">
        <div class="pdf-toolbar">
            <h3>ğŸ“„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© - A4</h3>
            <div class="pdf-toolbar-buttons">
                <button onclick="printFromPreview()" class="btn btn-success btn-sm">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4</button>
                <button onclick="downloadPDF()" class="btn btn-primary btn-sm">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button>
                <button onclick="closePDFModal()" class="btn btn-danger btn-sm">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
        <div class="pdf-content">
            <div class="pdf-frame" id="pdfFrame"></div>
        </div>
    </div>
    
    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar w-64 p-4 flex flex-col fixed h-full" id="sidebar">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-2xl mx-auto mb-3 flex items-center justify-center text-2xl shadow-lg">ğŸ§¾</div>
                <h1 class="text-white text-xl font-bold">Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h1>
                <p class="text-gray-400 text-sm">Ø¥Ø¯Ø§Ø±Ø© Ø³Ù‡Ù„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©</p>
            </div>
            <nav class="flex-1 space-y-2">
                <button class="nav-btn active w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('dashboard')"><span class="text-xl">ğŸ“Š</span><span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></button>
                <button class="nav-btn w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('new-invoice')"><span class="text-xl">â•</span><span>ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></button>
                <button class="nav-btn w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('saved-invoices')"><span class="text-xl">ğŸ“</span><span>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span></button>
                <button class="nav-btn w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('preview')"><span class="text-xl">ğŸ‘ï¸</span><span>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span></button>
                <button class="nav-btn w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('clients')"><span class="text-xl">ğŸ‘¥</span><span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></button>
                <button class="nav-btn w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('products')"><span class="text-xl">ğŸ“¦</span><span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></button>
                <button class="nav-btn w-full text-right text-white p-3 rounded-lg flex items-center gap-3" onclick="showPage('settings')"><span class="text-xl">âš™ï¸</span><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
            </nav>
            <div class="border-t border-gray-700 pt-4">
                <button onclick="exportAllData()" class="w-full text-gray-400 hover:text-white p-2 rounded-lg flex items-center gap-3 transition"><span>ğŸ“¤</span><span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content flex-1">
            
            <!-- Dashboard -->
            <div id="page-dashboard" class="page-content active">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-white mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
                    <p class="text-blue-200">Ø¥Ù„ÙŠÙƒ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù†Ø´Ø§Ø·Ùƒ</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="stats-card"><div class="flex justify-between items-center"><div><p class="text-white/70 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p><p class="text-3xl font-bold" id="stats-clients">0</p></div><span class="text-4xl">ğŸ‘¥</span></div></div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><div class="flex justify-between items-center"><div><p class="text-white/70 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p><p class="text-3xl font-bold" id="stats-products">0</p></div><span class="text-4xl">ğŸ“¦</span></div></div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><div class="flex justify-between items-center"><div><p class="text-white/70 text-sm">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</p><p class="text-3xl font-bold" id="stats-invoices">0</p></div><span class="text-4xl">ğŸ“</span></div></div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><div class="flex justify-between items-center"><div><p class="text-white/70 text-sm">Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p><p class="text-3xl font-bold" id="stats-total">0 DA</p></div><span class="text-4xl">ğŸ’°</span></div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6"><h3 class="font-bold text-lg mb-4">ğŸš€ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3><div class="grid grid-cols-2 gap-3"><button onclick="showPage('new-invoice')" class="btn btn-primary">â• ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="showPage('saved-invoices')" class="btn btn-teal">ğŸ“ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button><button onclick="showPage('clients')" class="btn btn-warning">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button><button onclick="showPage('products')" class="btn btn-purple">ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button></div></div>
                    <div class="card p-6"><h3 class="font-bold text-lg mb-4">ğŸ“‹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3><div id="dashboard-items"><p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</p></div></div>
                </div>
            </div>
            
            <!-- New Invoice -->
            <div id="page-new-invoice" class="page-content">
                <div class="mb-6"><h2 class="text-3xl font-bold text-white mb-2">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© â•</h2><p class="text-blue-200">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ“„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group"><label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input type="text" id="invoiceNumber" value="01/2026"></div>
                            <div class="input-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="invoiceDate"></div>
                        </div>
                        <div class="input-group"><label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="paymentMethod"><option value="Ã€ TERME">Ã€ TERME (Ø¢Ø¬Ù„)</option><option value="ESPÃˆCES">ESPÃˆCES (Ù†Ù‚Ø¯Ø§Ù‹)</option><option value="CHÃˆQUE">CHÃˆQUE (Ø´ÙŠÙƒ)</option><option value="VIREMENT">VIREMENT (ØªØ­ÙˆÙŠÙ„)</option></select></div>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ‘¤ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                        <div class="input-group"><label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label><select id="clientSelect" onchange="onClientChange()"><option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option></select></div>
                        <div id="selectedClientInfo" class="bg-gray-50 rounded-lg p-4 text-sm hidden"><p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="infoName">-</span></p><p><strong>Ø§Ù„Ù†Ø´Ø§Ø·:</strong> <span id="infoJob">-</span></p><p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="infoAddress">-</span></p></div>
                    </div>
                </div>
                <div class="card p-6 mt-6">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="input-group"><label>Ø§Ù„Ù…Ù†ØªØ¬</label><select id="productSelect" onchange="onProductChange()"><option value="">-- Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ --</option></select></div>
                        <div class="input-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="productQty" value="1" min="1"></div>
                        <div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="productPrice" placeholder="0.00"></div>
                        <div class="flex items-end"><button onclick="addProductToInvoice()" class="btn btn-success w-full">â• Ø¥Ø¶Ø§ÙØ©</button></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-100"><tr><th class="p-3 text-right border">#</th><th class="p-3 text-right border">Ø§Ù„Ù…Ù†ØªØ¬</th><th class="p-3 text-center border">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th class="p-3 text-center border">Ø§Ù„Ø³Ø¹Ø±</th><th class="p-3 text-center border">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th class="p-3 text-center border">Ø­Ø°Ù</th></tr></thead>
                            <tbody id="invoiceItemsList"><tr><td colspan="6" class="p-4 text-center text-gray-500 border">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr></tbody>
                            <tfoot class="bg-gray-100 font-bold"><tr><td colspan="4" class="p-3 text-left border">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td class="p-3 text-center border" id="invoiceTotal">0.00 DA</td><td class="border"></td></tr></tfoot>
                        </table>
                    </div>
                </div>
                <div class="flex gap-4 mt-6 flex-wrap">
                    <button onclick="saveInvoice()" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                    <button onclick="showPage('preview')" class="btn btn-primary">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                    <button onclick="clearCurrentInvoice()" class="btn btn-danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                </div>
            </div>
            
            <!-- Saved Invoices -->
            <div id="page-saved-invoices" class="page-content">
                <div class="mb-6"><h2 class="text-3xl font-bold text-white mb-2">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ğŸ“</h2><p class="text-blue-200">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</p></div>
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2"><h3 class="font-bold text-lg">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3><button onclick="clearAllSavedInvoices()" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button></div>
                    <div id="savedInvoicesList" class="space-y-3"><p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©</p></div>
                </div>
            </div>
            
            <!-- Preview -->
            <div id="page-preview" class="page-content">
                <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
                    <div><h2 class="text-3xl font-bold text-white mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ğŸ‘ï¸</h2><p class="text-blue-200">Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</p></div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="openPrintPreview()" class="btn btn-success">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4</button>
                        <button onclick="openPDFPreview()" class="btn btn-primary">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
                    </div>
                </div>
                
                <div class="invoice-preview" id="invoice">
                    <!-- Header -->
                    <div class="invoice-header">
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-bottom: 5px;">
                            <div><strong>NÂ° Carte :</strong> 22260013954</div>
                            <div><strong>MF NÂ° :</strong> 185261800357101</div>
                        </div>
                        <div class="seller-name">ÙˆÙ„Ø¯Ø¨ÙˆØ²ÙŠØ¯ÙŠ Ø¹Ù…Ø±</div>
                        <div style="font-size: 12px; color: #333; direction: rtl; margin-bottom: 3px;">ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø£ÙØ±Ø´Ø©</div>
                        <div style="font-size: 15px; font-weight: bold; color: #000; direction: rtl;">Ø­Ø±ÙÙŠ ØµØ§Ù†Ø¹ Ø£ÙØ±Ø´Ø© Ø§Ù„Ø£Ø³Ø±Ø©</div>
                        <div style="font-size: 11px; color: #333; font-style: italic; margin-bottom: 3px;">Artisan Fabricant de Literie</div>
                        <div style="font-size: 11px; color: #333; direction: rtl; padding-top: 5px; border-top: 1px solid #999;">Ø¨Ù„Ø¯ÙŠØ© Ø´Ù„Ø§Ù„Ø© Ø§Ù„Ø¹Ø°Ø§ÙˆØ±Ø© â€“ ÙˆÙ„Ø§ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ©</div>
                    </div>
                    
                    <!-- Date -->
                    <div style="text-align: right; margin-bottom: 10px; padding: 5px 10px; border: 1px solid #000; font-size: 12px;">
                        <strong>FAIT LE :</strong> <span id="displayDate">01/01/2026</span>
                    </div>
                    
                    <!-- Invoice Number -->
                    <div style="text-align: center; margin: 10px 0; padding: 8px; border: 2px solid #000;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: bold; color: #000;">
                            FACTURE NÂ° : <span id="displayInvoiceNumber">01/2026</span>
                        </h2>
                    </div>
                    
                    <!-- Client Info -->
                    <div style="display: flex; justify-content: center; margin: 10px 0;">
                        <div style="border: 1px solid #000; padding: 8px 15px; font-size: 11px; line-height: 1.6;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px 25px; text-align: left;">
                                <div><strong>Client :</strong> <span id="clientName">-</span></div>
                                <div><strong>RC NÂ° :</strong> <span id="clientRC">-</span></div>
                                <div><strong>ActivitÃ© :</strong> <span id="clientJob">-</span></div>
                                <div><strong>IF NÂ° :</strong> <span id="clientIF">-</span></div>
                                <div><strong>Adresse :</strong> <span id="clientAddress">-</span></div>
                                <div><strong>ART NÂ° :</strong> <span id="clientART">-</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Table -->
                    <table class="invoice-table" dir="ltr" style="direction: ltr; text-align: left; margin-top: 10px;">
                        <thead>
                            <tr>
                                <th style="width: 5%;">NÂ°</th>
                                <th style="width: 40%;">DESCRIPTION</th>
                                <th style="width: 10%;">QTÃ‰</th>
                                <th style="width: 10%;">UNITÃ‰</th>
                                <th style="width: 15%;">P.U</th>
                                <th style="width: 20%;">MONTANT</th>
                            </tr>
                        </thead>
                        <tbody id="previewItems">
                            <tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">Aucun produit</td></tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold; background: #e8e8e8; padding: 8px;">Total HT</td>
                                <td style="text-align: right; background: #e8e8e8; padding: 8px;"><strong id="previewTotal">0,00 DA</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <!-- Amount in Words -->
                    <div dir="ltr" style="direction: ltr; text-align: left; border: 2px solid #000; padding: 10px; margin-top: 15px;">
                        ArrÃªtÃ©e la prÃ©sente facture Ã  la somme de :<br>
                        <strong id="amountInWords">ZÃ©ro dinar algÃ©rien</strong>
                    </div>
                    
                    <!-- Footer -->
                    <div dir="ltr" style="direction: ltr; text-align: left; margin-top: 15px;">
                        <div style="border: 1px solid #000; padding: 6px 10px; font-size: 11px;">
                            Ne relÃ¨ve pas de la TVA 19% + taxe de timbre
                        </div>
                        <div style="margin-top: 10px; font-size: 13px;">
                            <strong>MODE DE PAIEMENT :</strong> <span id="displayPaymentMethod">Ã€ TERME</span>
                        </div>
                        <br><br><br>
                        <div style="text-align: right;">
                            <div style="border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 180px; text-align: center;">
                                <strong>Le fournisseur</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Clients -->
            <div id="page-clients" class="page-content">
                <div class="mb-6"><h2 class="text-3xl font-bold text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ğŸ‘¥</h2><p class="text-blue-200">Ø£Ø¶Ù ÙˆØ¹Ø¯Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
                        <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="newClientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"></div>
                        <div class="input-group"><label>Ø§Ù„Ù†Ø´Ø§Ø·</label><input type="text" id="newClientJob" placeholder="Ø§Ù„Ù…Ù‡Ù†Ø©/Ø§Ù„Ù†Ø´Ø§Ø·"></div>
                        <div class="input-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="newClientAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div>
                        <div class="input-group"><label>RC NÂ°</label><input type="text" id="newClientRC" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"></div>
                        <div class="input-group"><label>IF NÂ°</label><input type="text" id="newClientIF" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ø¨Ø§Ø¦ÙŠ"></div>
                        <div class="input-group"><label>ART NÂ°</label><input type="text" id="newClientART" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø©"></div>
                        <button onclick="addNewClient()" class="btn btn-success w-full">âœ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                    </div>
                    <div class="card p-6 lg:col-span-2"><h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3><div class="space-y-3" id="clientsList"><p class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div></div>
                </div>
            </div>
            
            <!-- Products -->
            <div id="page-products" class="page-content">
                <div class="mb-6"><h2 class="text-3xl font-bold text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ğŸ“¦</h2><p class="text-blue-200">Ø£Ø¶Ù ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</p></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="newProductName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"></div>
                        <div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label><input type="number" id="newProductPrice" placeholder="0.00"></div>
                        <div class="input-group"><label>Ø§Ù„ÙˆØ­Ø¯Ø©</label><input type="text" id="newProductUnit" value="U" placeholder="U, KG, M..."></div>
                        <button onclick="addNewProduct()" class="btn btn-success w-full">âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                    </div>
                    <div class="card p-6 lg:col-span-2"><h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3><div class="space-y-3" id="productsList"><p class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div></div>
                </div>
            </div>
            
            <!-- Settings -->
            <div id="page-settings" class="page-content">
                <div class="mb-6"><h2 class="text-3xl font-bold text-white mb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</h2><p class="text-blue-200">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6"><h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3><div class="space-y-4"><button onclick="exportAllData()" class="btn btn-primary w-full">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button><div><input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)"><button onclick="document.getElementById('importFile').click()" class="btn btn-warning w-full">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></div></div></div>
                    <div class="card p-6"><h3 class="font-bold text-lg mb-4 border-b pb-2">ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3><div class="space-y-4"><button onclick="clearCurrentInvoice()" class="btn btn-danger w-full">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button><button onclick="resetAllData()" class="btn btn-danger w-full">âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></div></div>
                </div>
            </div>
            
        </main>
    </div>

    <script>
        // ==================== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
        let appData = {
            clients: [
                { id: 1, name: "OULD BOUZIDI LAID", job: "CommerÃ§ant", address: "W DE MEDEA", rc: "26/00 1760198 D 17", if: "79926189003603", art: "26230062030" },
                { id: 2, name: "AHMED BENALI", job: "Grossiste", address: "W D'ALGER", rc: "16/00 1234567 A 01", if: "12345678901234", art: "16010012345" }
            ],
            products: [
                { id: 1, name: "Bessat 2 piÃ¨ces", price: 800, unit: "U" },
                { id: 2, name: "Couette", price: 650, unit: "U" },
                { id: 3, name: "Rideau", price: 800, unit: "U" },
                { id: 4, name: "Tefricha", price: 400, unit: "U" },
                { id: 5, name: "Oreiller", price: 250, unit: "U" }
            ],
            invoiceItems: [],
            savedInvoices: []
        };

        function loadAppData() { try { const s = localStorage.getItem('invoiceAppData'); if (s) appData = { ...appData, ...JSON.parse(s) }; } catch(e) {} }
        function saveAppData() { try { localStorage.setItem('invoiceAppData', JSON.stringify(appData)); } catch(e) {} }
        
        function initApp() {
            loadAppData();
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            updateClientSelect(); updateProductSelect(); renderClients(); renderProducts();
            renderInvoiceItems(); renderSavedInvoices(); updateStats();
        }

        function showPage(pageName) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const page = document.getElementById('page-' + pageName);
            if (page) page.classList.add('active');
            const pages = ['dashboard', 'new-invoice', 'saved-invoices', 'preview', 'clients', 'products', 'settings'];
            document.querySelectorAll('.nav-btn').forEach((btn, i) => { if (pages[i] === pageName) btn.classList.add('active'); });
            if (pageName === 'preview') updatePreview();
            if (pageName === 'saved-invoices') renderSavedInvoices();
            closeMobileMenu();
        }

        function toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('active'); }
        function closeMobileMenu() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); }

        // ==================== Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ====================
        function updateClientSelect() { const s = document.getElementById('clientSelect'); s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>'; appData.clients.forEach(c => { s.innerHTML += '<option value="'+c.id+'">'+c.name+'</option>'; }); }
        function onClientChange() { const c = appData.clients.find(x => x.id == document.getElementById('clientSelect').value); const i = document.getElementById('selectedClientInfo'); if (c) { i.classList.remove('hidden'); document.getElementById('infoName').textContent = c.name; document.getElementById('infoJob').textContent = c.job||'-'; document.getElementById('infoAddress').textContent = c.address||'-'; } else i.classList.add('hidden'); }
        function addNewClient() { const n = document.getElementById('newClientName').value.trim(); if (!n) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'); return; } appData.clients.push({ id: Date.now(), name: n, job: document.getElementById('newClientJob').value.trim(), address: document.getElementById('newClientAddress').value.trim(), rc: document.getElementById('newClientRC').value.trim(), if: document.getElementById('newClientIF').value.trim(), art: document.getElementById('newClientART').value.trim() }); saveAppData(); updateClientSelect(); renderClients(); updateStats(); ['newClientName','newClientJob','newClientAddress','newClientRC','newClientIF','newClientART'].forEach(id => document.getElementById(id).value = ''); alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ âœ…'); }
        function renderClients() { const c = document.getElementById('clientsList'); if (!appData.clients.length) { c.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</p>'; return; } let h = ''; appData.clients.forEach(x => { h += '<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><div><strong>'+x.name+'</strong><p class="text-sm text-gray-500">'+(x.job||'')+' - '+(x.address||'')+'</p></div><div class="flex gap-2"><button onclick="openEditClient('+x.id+')" class="btn btn-primary btn-sm">âœï¸</button><button onclick="deleteClient('+x.id+')" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button></div></div>'; }); c.innerHTML = h; }
        function openEditClient(id) { const c = appData.clients.find(x => x.id === id); if (!c) return; document.getElementById('editClientId').value = id; document.getElementById('editClientName').value = c.name; document.getElementById('editClientJob').value = c.job||''; document.getElementById('editClientAddress').value = c.address||''; document.getElementById('editClientRC').value = c.rc||''; document.getElementById('editClientIF').value = c.if||''; document.getElementById('editClientART').value = c.art||''; document.getElementById('editClientModal').classList.add('active'); }
        function saveEditedClient() { const id = parseInt(document.getElementById('editClientId').value); const c = appData.clients.find(x => x.id === id); if (!c) return; c.name = document.getElementById('editClientName').value.trim(); c.job = document.getElementById('editClientJob').value.trim(); c.address = document.getElementById('editClientAddress').value.trim(); c.rc = document.getElementById('editClientRC').value.trim(); c.if = document.getElementById('editClientIF').value.trim(); c.art = document.getElementById('editClientART').value.trim(); saveAppData(); updateClientSelect(); renderClients(); closeModal('editClientModal'); alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…'); }
        function deleteClient(id) { if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return; appData.clients = appData.clients.filter(x => x.id !== id); saveAppData(); updateClientSelect(); renderClients(); updateStats(); }

        // ==================== Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ====================
        function updateProductSelect() { const s = document.getElementById('productSelect'); s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ --</option>'; appData.products.forEach(p => { s.innerHTML += '<option value="'+p.id+'">'+p.name+' - '+formatNumber(p.price)+' DA</option>'; }); }
        function onProductChange() { const p = appData.products.find(x => x.id == document.getElementById('productSelect').value); if (p) document.getElementById('productPrice').value = p.price; }
        function addNewProduct() { const n = document.getElementById('newProductName').value.trim(); if (!n) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'); return; } appData.products.push({ id: Date.now(), name: n, price: parseFloat(document.getElementById('newProductPrice').value)||0, unit: document.getElementById('newProductUnit').value.trim()||'U' }); saveAppData(); updateProductSelect(); renderProducts(); updateStats(); document.getElementById('newProductName').value = ''; document.getElementById('newProductPrice').value = ''; document.getElementById('newProductUnit').value = 'U'; alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ âœ…'); }
        function renderProducts() { const c = document.getElementById('productsList'); if (!appData.products.length) { c.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>'; return; } let h = ''; appData.products.forEach(p => { h += '<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><div><strong>'+p.name+'</strong><p class="text-sm text-gray-500">'+formatNumber(p.price)+' DA / '+p.unit+'</p></div><div class="flex gap-2"><button onclick="openEditProduct('+p.id+')" class="btn btn-primary btn-sm">âœï¸</button><button onclick="deleteProduct('+p.id+')" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button></div></div>'; }); c.innerHTML = h; }
        function openEditProduct(id) { const p = appData.products.find(x => x.id === id); if (!p) return; document.getElementById('editProductId').value = id; document.getElementById('editProductName').value = p.name; document.getElementById('editProductPrice').value = p.price; document.getElementById('editProductUnit').value = p.unit; document.getElementById('editProductModal').classList.add('active'); }
        function saveEditedProduct() { const id = parseInt(document.getElementById('editProductId').value); const p = appData.products.find(x => x.id === id); if (!p) return; p.name = document.getElementById('editProductName').value.trim(); p.price = parseFloat(document.getElementById('editProductPrice').value)||0; p.unit = document.getElementById('editProductUnit').value.trim()||'U'; saveAppData(); updateProductSelect(); renderProducts(); closeModal('editProductModal'); alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…'); }
        function deleteProduct(id) { if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return; appData.products = appData.products.filter(x => x.id !== id); saveAppData(); updateProductSelect(); renderProducts(); updateStats(); }

        // ==================== Ø§Ù„ÙØ§ØªÙˆØ±Ø© ====================
        function addProductToInvoice() { const pid = document.getElementById('productSelect').value; if (!pid) { alert('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬'); return; } const p = appData.products.find(x => x.id == pid); const qty = parseInt(document.getElementById('productQty').value)||1; const price = parseFloat(document.getElementById('productPrice').value)||p.price; appData.invoiceItems.push({ id: Date.now(), name: p.name, qty, unit: p.unit, price, total: qty*price }); saveAppData(); renderInvoiceItems(); updateStats(); document.getElementById('productSelect').value = ''; document.getElementById('productQty').value = '1'; document.getElementById('productPrice').value = ''; }
        
        function renderInvoiceItems() {
            const tbody = document.getElementById('invoiceItemsList');
            const dash = document.getElementById('dashboard-items');
            if (!appData.invoiceItems.length) { tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500 border">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>'; dash.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p>'; document.getElementById('invoiceTotal').textContent = '0.00 DA'; return; }
            let total = 0, h = '', dh = '';
            appData.invoiceItems.forEach((item, i) => { total += item.total; h += '<tr><td class="p-3 border">'+(i+1)+'</td><td class="p-3 border">'+item.name+'</td><td class="p-3 text-center border">'+item.qty+'</td><td class="p-3 text-center border">'+formatNumber(item.price)+'</td><td class="p-3 text-center border">'+formatNumber(item.total)+'</td><td class="p-3 text-center border"><button onclick="removeInvoiceItem('+item.id+')" class="text-red-500">ğŸ—‘ï¸</button></td></tr>'; dh += '<div class="flex justify-between p-2 bg-gray-50 rounded mb-2"><span>'+item.name+'</span><span class="text-gray-500">Ã—'+item.qty+'</span><span class="font-bold">'+formatNumber(item.total)+' DA</span></div>'; });
            tbody.innerHTML = h; dash.innerHTML = dh; document.getElementById('invoiceTotal').textContent = formatNumber(total) + ' DA';
        }
        
        function removeInvoiceItem(id) { appData.invoiceItems = appData.invoiceItems.filter(x => x.id !== id); saveAppData(); renderInvoiceItems(); updateStats(); }
        function clearCurrentInvoice() { if (!confirm('Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) return; appData.invoiceItems = []; saveAppData(); renderInvoiceItems(); updateStats(); }

        // ==================== Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ====================
        function saveInvoice() {
            if (!appData.invoiceItems.length) { alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª!'); return; }
            const cid = document.getElementById('clientSelect').value;
            if (!cid) { alert('âŒ Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„!'); return; }
            const client = appData.clients.find(c => c.id == cid);
            const total = appData.invoiceItems.reduce((s, i) => s + i.total, 0);
            appData.savedInvoices.push({ id: Date.now(), invoiceNumber: document.getElementById('invoiceNumber').value, date: document.getElementById('invoiceDate').value, paymentMethod: document.getElementById('paymentMethod').value, client, items: JSON.parse(JSON.stringify(appData.invoiceItems)), total, savedAt: new Date().toLocaleString('ar-DZ') });
            saveAppData();
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!\n\nØ±Ù‚Ù…: ' + document.getElementById('invoiceNumber').value + '\nØ§Ù„Ø¹Ù…ÙŠÙ„: ' + client.name + '\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + formatNumber(total) + ' DA');
            const parts = document.getElementById('invoiceNumber').value.split('/');
            if (parts.length === 2) document.getElementById('invoiceNumber').value = (parseInt(parts[0])+1).toString().padStart(2,'0') + '/' + parts[1];
            appData.invoiceItems = []; document.getElementById('clientSelect').value = ''; document.getElementById('selectedClientInfo').classList.add('hidden');
            saveAppData(); renderInvoiceItems(); updateStats();
        }

        // ==================== Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ====================
        function renderSavedInvoices() {
            const c = document.getElementById('savedInvoicesList');
            if (!appData.savedInvoices.length) { c.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</p>'; return; }
            let h = '';
            [...appData.savedInvoices].reverse().forEach(inv => {
                h += '<div class="bg-gray-50 rounded-lg p-4 mb-3"><div class="flex justify-between items-start flex-wrap gap-2"><div><h4 class="font-bold text-lg">ÙØ§ØªÙˆØ±Ø©: '+inv.invoiceNumber+'</h4><p class="text-sm text-gray-600">'+inv.client.name+'</p><p class="text-sm text-gray-500">'+inv.date+'</p></div><div class="text-left"><p class="font-bold text-lg text-green-600">'+formatNumber(inv.total)+' DA</p><p class="text-xs text-gray-500">'+inv.items.length+' Ù…Ù†ØªØ¬</p></div></div>';
                h += '<div class="flex gap-2 mt-3 flex-wrap"><button onclick="loadSavedInvoice('+inv.id+')" class="btn btn-primary btn-sm">ğŸ“‚ ÙØªØ­</button><button onclick="printSavedInvoice('+inv.id+')" class="btn btn-success btn-sm">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="exportSavedInvoicePDF('+inv.id+')" class="btn btn-teal btn-sm">ğŸ“„ PDF</button><button onclick="deleteSavedInvoice('+inv.id+')" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Ø­Ø°Ù</button></div></div>';
            });
            c.innerHTML = h;
        }

        function loadSavedInvoice(id) { const inv = appData.savedInvoices.find(x => x.id === id); if (!inv) return; appData.invoiceItems = JSON.parse(JSON.stringify(inv.items)); document.getElementById('invoiceNumber').value = inv.invoiceNumber; document.getElementById('invoiceDate').value = inv.date; document.getElementById('paymentMethod').value = inv.paymentMethod; document.getElementById('clientSelect').value = inv.client.id; onClientChange(); saveAppData(); renderInvoiceItems(); updateStats(); showPage('new-invoice'); alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!'); }
        function deleteSavedInvoice(id) { if (!confirm('Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) return; appData.savedInvoices = appData.savedInvoices.filter(x => x.id !== id); saveAppData(); renderSavedInvoices(); updateStats(); }
        function clearAllSavedInvoices() { if (!confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŸ')) return; appData.savedInvoices = []; saveAppData(); renderSavedInvoices(); updateStats(); }

        // ==================== Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ====================
        function updatePreview() {
            const d = document.getElementById('invoiceDate').value;
            if (d) document.getElementById('displayDate').textContent = new Date(d).toLocaleDateString('fr-FR');
            document.getElementById('displayInvoiceNumber').textContent = document.getElementById('invoiceNumber').value;
            document.getElementById('displayPaymentMethod').textContent = document.getElementById('paymentMethod').value;
            const client = appData.clients.find(c => c.id == document.getElementById('clientSelect').value);
            if (client) { document.getElementById('clientName').textContent = client.name; document.getElementById('clientJob').textContent = client.job||'-'; document.getElementById('clientAddress').textContent = client.address||'-'; document.getElementById('clientRC').textContent = client.rc||'-'; document.getElementById('clientIF').textContent = client.if||'-'; document.getElementById('clientART').textContent = client.art||'-'; }
            const tbody = document.getElementById('previewItems');
            if (!appData.invoiceItems.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">Aucun produit</td></tr>'; document.getElementById('previewTotal').textContent = '0,00 DA'; document.getElementById('amountInWords').textContent = 'ZÃ©ro dinar algÃ©rien'; return; }
            let total = 0, h = '';
            appData.invoiceItems.forEach((item, i) => { total += item.total; h += '<tr><td style="text-align:center;">'+(i+1)+'</td><td>'+item.name+'</td><td style="text-align:center;">'+item.qty+'</td><td style="text-align:center;">'+item.unit+'</td><td style="text-align:right;">'+formatNumber(item.price)+'</td><td style="text-align:right;">'+formatNumber(item.total)+'</td></tr>'; });
            tbody.innerHTML = h;
            document.getElementById('previewTotal').textContent = formatNumber(total) + ' DA';
            document.getElementById('amountInWords').textContent = numberToFrench(total) + ' (' + formatNumber(total) + ' DA)';
        }

        // ==================== Ø§Ù„Ø£Ø¯ÙˆØ§Øª ====================
        function formatNumber(n) { return Number(n).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        
        function numberToFrench(num) {
            if (num === 0) return 'ZÃ©ro dinar algÃ©rien';
            const ones = ['','un','deux','trois','quatre','cinq','six','sept','huit','neuf','dix','onze','douze','treize','quatorze','quinze','seize','dix-sept','dix-huit','dix-neuf'];
            const tens = ['','','vingt','trente','quarante','cinquante','soixante','soixante','quatre-vingt','quatre-vingt'];
            function convertHundreds(n) { let r = ''; if (n >= 100) { r += (Math.floor(n/100) === 1 ? 'cent ' : ones[Math.floor(n/100)] + ' cent '); n %= 100; } if (n >= 20) { const t = Math.floor(n/10), o = n%10; if (t===7||t===9) r += tens[t]+'-'+ones[10+o]+' '; else if (t===8&&o===0) r += 'quatre-vingts '; else r += tens[t]+(o===1&&t!==8?' et ':(o>0?'-':' '))+ones[o]+' '; } else if (n > 0) r += ones[n]+' '; return r; }
            let r = ''; const m = Math.floor(num/1000000); const th = Math.floor((num%1000000)/1000); const rem = Math.floor(num%1000);
            if (m > 0) r += convertHundreds(m)+'million'+(m>1?'s ':' '); if (th > 0) r += (th===1?'mille ':convertHundreds(th)+'mille '); if (rem > 0) r += convertHundreds(rem);
            return r.trim().charAt(0).toUpperCase() + r.trim().slice(1) + ' dinars algÃ©riens';
        }

        function updateStats() { document.getElementById('stats-clients').textContent = appData.clients.length; document.getElementById('stats-products').textContent = appData.products.length; document.getElementById('stats-invoices').textContent = appData.savedInvoices.length; document.getElementById('stats-total').textContent = formatNumber(appData.invoiceItems.reduce((s,i) => s+i.total, 0)) + ' DA'; }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // ==================== HTML Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (A4 Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯) ====================
        function getInvoiceHTML(invoice) {
            let itemsHtml = '', total = 0;
            const items = invoice ? invoice.items : appData.invoiceItems;
            const client = invoice ? invoice.client : appData.clients.find(c => c.id == document.getElementById('clientSelect').value);
            const invoiceNum = invoice ? invoice.invoiceNumber : document.getElementById('invoiceNumber').value;
            const invoiceDate = invoice ? invoice.date : document.getElementById('invoiceDate').value;
            const paymentMethod = invoice ? invoice.paymentMethod : document.getElementById('paymentMethod').value;
            
            items.forEach((item, i) => {
                total += item.total;
                itemsHtml += '<tr><td style="text-align:center;border:1px solid #000;padding:6px;">'+( i+1)+'</td><td style="border:1px solid #000;padding:6px;">'+item.name+'</td><td style="text-align:center;border:1px solid #000;padding:6px;">'+item.qty+'</td><td style="text-align:center;border:1px solid #000;padding:6px;">'+item.unit+'</td><td style="text-align:right;border:1px solid #000;padding:6px;">'+formatNumber(item.price)+'</td><td style="text-align:right;border:1px solid #000;padding:6px;">'+formatNumber(item.total)+'</td></tr>';
            });
            
            const dateF = invoiceDate ? new Date(invoiceDate).toLocaleDateString('fr-FR') : '';
            
            return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Facture ${invoiceNum}</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
@page { size: A4; margin: 15mm 20mm; }
body { font-family: "Times New Roman", serif; font-size: 13px; color: #000; width: 210mm; min-height: 297mm; padding: 15mm 20mm; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
.header { text-align: center; padding: 10px 15px; margin-bottom: 12px; border: 2px solid #000; }
.seller-name { font-family: 'Amiri', serif; font-size: 26px; font-weight: 700; color: #000; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #000; padding: 6px 8px; }
th { background: #e8e8e8 !important; font-weight: bold; text-align: center; font-size: 12px; }
.total-row td { background: #e8e8e8 !important; }
</style></head><body>
<div class="header">
<div style="display:flex;justify-content:space-between;font-size:10px;color:#333;margin-bottom:5px;"><div><strong>NÂ° Carte :</strong> 22260013954</div><div><strong>MF NÂ° :</strong> 185261800357101</div></div>
<div class="seller-name">ÙˆÙ„Ø¯Ø¨ÙˆØ²ÙŠØ¯ÙŠ Ø¹Ù…Ø±</div>
<div style="font-size:12px;color:#333;">ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø£ÙØ±Ø´Ø©</div>
<div style="font-size:15px;font-weight:bold;color:#000;">Ø­Ø±ÙÙŠ ØµØ§Ù†Ø¹ Ø£ÙØ±Ø´Ø© Ø§Ù„Ø£Ø³Ø±Ø©</div>
<div style="font-size:11px;color:#333;font-style:italic;">Artisan Fabricant de Literie</div>
<div style="font-size:11px;color:#333;padding-top:5px;border-top:1px solid #999;">Ø¨Ù„Ø¯ÙŠØ© Ø´Ù„Ø§Ù„Ø© Ø§Ù„Ø¹Ø°Ø§ÙˆØ±Ø© â€“ ÙˆÙ„Ø§ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ©</div>
</div>
<div style="text-align:right;margin-bottom:10px;padding:5px 10px;border:1px solid #000;font-size:12px;"><strong>FAIT LE :</strong> ${dateF}</div>
<div style="text-align:center;margin:10px 0;padding:8px;border:2px solid #000;"><h2 style="margin:0;font-size:20px;font-weight:bold;color:#000;">FACTURE NÂ° : ${invoiceNum}</h2></div>
<div style="display:flex;justify-content:center;margin:10px 0;"><div style="border:1px solid #000;padding:8px 15px;font-size:11px;line-height:1.6;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:3px 25px;text-align:left;"><div><strong>Client :</strong> ${client?.name||'-'}</div><div><strong>RC NÂ° :</strong> ${client?.rc||'-'}</div><div><strong>ActivitÃ© :</strong> ${client?.job||'-'}</div><div><strong>IF NÂ° :</strong> ${client?.if||'-'}</div><div><strong>Adresse :</strong> ${client?.address||'-'}</div><div><strong>ART NÂ° :</strong> ${client?.art||'-'}</div></div></div></div>
<table style="direction:ltr;margin-top:10px;"><thead><tr><th style="width:5%;">NÂ°</th><th style="width:40%;">DESCRIPTION</th><th style="width:10%;">QTÃ‰</th><th style="width:10%;">UNITÃ‰</th><th style="width:15%;">P.U</th><th style="width:20%;">MONTANT</th></tr></thead>
<tbody>${itemsHtml}</tbody>
<tfoot><tr class="total-row"><td colspan="5" style="text-align:right;font-weight:bold;background:#e8e8e8;padding:8px;">Total HT</td><td style="text-align:right;background:#e8e8e8;padding:8px;"><strong>${formatNumber(total)} DA</strong></td></tr></tfoot></table>
<div style="border:2px solid #000;padding:10px;margin-top:15px;">ArrÃªtÃ©e la prÃ©sente facture Ã  la somme de :<br><strong>${numberToFrench(total)} (${formatNumber(total)} DA)</strong></div>
<div style="margin-top:15px;"><div style="border:1px solid #000;padding:6px 10px;font-size:11px;">Ne relÃ¨ve pas de la TVA 19% + taxe de timbre</div><div style="margin-top:10px;font-size:13px;"><strong>MODE DE PAIEMENT :</strong> ${paymentMethod}</div><br><br><br><div style="text-align:right;"><div style="border-top:1px solid #000;display:inline-block;padding-top:5px;min-width:180px;text-align:center;"><strong>Le fournisseur</strong></div></div></div>
</body></html>`;
        }

        // ==================== Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ====================
        function openPrintPreview() {
            if (!appData.invoiceItems.length) { alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª!'); return; }
            updatePreview();
            const html = getInvoiceHTML(null);
            const w = window.open('', '_blank');
            if (!w) { alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©'); return; }
            w.document.write(html);
            w.document.close();
            w.onload = function() { w.focus(); w.print(); };
        }

        function printSavedInvoice(id) {
            const inv = appData.savedInvoices.find(x => x.id === id);
            if (!inv) return;
            const html = getInvoiceHTML(inv);
            const w = window.open('', '_blank');
            if (!w) { alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©'); return; }
            w.document.write(html);
            w.document.close();
            w.onload = function() { w.focus(); w.print(); };
        }

        // ==================== PDF ====================
        function openPDFPreview() {
            if (!appData.invoiceItems.length) { alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª!'); return; }
            updatePreview();
            const pdfFrame = document.getElementById('pdfFrame');
            pdfFrame.innerHTML = document.getElementById('invoice').innerHTML;
            document.getElementById('pdfModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePDFModal() { document.getElementById('pdfModal').classList.remove('active'); document.body.style.overflow = ''; }

        function printFromPreview() {
            const html = getInvoiceHTML(null);
            const w = window.open('', '_blank');
            if (!w) { alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©'); return; }
            w.document.write(html);
            w.document.close();
            w.onload = function() { w.focus(); w.print(); };
        }

        function showLoading(msg) { const o = document.createElement('div'); o.id = 'loadingOverlay'; o.className = 'loading-overlay'; o.innerHTML = '<div class="loading-box"><div class="loading-icon">â³</div><div>'+msg+'</div></div>'; document.body.appendChild(o); }
        function hideLoading() { const o = document.getElementById('loadingOverlay'); if (o) o.remove(); }

        async function downloadPDF() {
            if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') { alert('â³ Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'); return; }
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ø¨ØªÙ†Ø³ÙŠÙ‚ A4...');
            try {
                await new Promise(r => setTimeout(r, 300));
                const element = document.getElementById('pdfFrame');
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff', logging: false, removeContainer: true, imageTimeout: 0 });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdfWidth = 210;
                const pdfHeight = 297;
                const imgWidth = pdfWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                if (imgHeight <= pdfHeight) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                } else {
                    let heightLeft = imgHeight, position = 0;
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                    while (heightLeft > 0) { position -= pdfHeight; pdf.addPage(); pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight); heightLeft -= pdfHeight; }
                }
                const invoiceNum = document.getElementById('invoiceNumber').value.replace('/', '-');
                pdf.save('Facture_' + invoiceNum + '.pdf');
                hideLoading();
                alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ PDF Ø¨ØªÙ†Ø³ÙŠÙ‚ A4 Ø¨Ù†Ø¬Ø§Ø­!\nğŸ“„ Facture_' + invoiceNum + '.pdf');
            } catch (e) { hideLoading(); console.error(e); alert('âŒ Ø®Ø·Ø£: ' + e.message); }
        }

        async function exportSavedInvoicePDF(id) {
            const inv = appData.savedInvoices.find(x => x.id === id);
            if (!inv) return;
            const tempItems = [...appData.invoiceItems];
            const tempClient = document.getElementById('clientSelect').value;
            const tempNum = document.getElementById('invoiceNumber').value;
            const tempDate = document.getElementById('invoiceDate').value;
            const tempPay = document.getElementById('paymentMethod').value;
            appData.invoiceItems = [...inv.items];
            document.getElementById('invoiceNumber').value = inv.invoiceNumber;
            document.getElementById('invoiceDate').value = inv.date;
            document.getElementById('paymentMethod').value = inv.paymentMethod;
            if (appData.clients.find(c => c.id === inv.client.id)) document.getElementById('clientSelect').value = inv.client.id;
            updatePreview();
            document.getElementById('pdfFrame').innerHTML = document.getElementById('invoice').innerHTML;
            document.getElementById('pdfModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => { appData.invoiceItems = tempItems; document.getElementById('clientSelect').value = tempClient; document.getElementById('invoiceNumber').value = tempNum; document.getElementById('invoiceDate').value = tempDate; document.getElementById('paymentMethod').value = tempPay; renderInvoiceItems(); }, 500);
        }

        // ==================== Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ====================
        function exportAllData() { const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'invoice_backup_' + new Date().toISOString().split('T')[0] + '.json'; a.click(); URL.revokeObjectURL(a.href); alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!'); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { appData = { ...appData, ...JSON.parse(e.target.result) }; saveAppData(); updateClientSelect(); updateProductSelect(); renderClients(); renderProducts(); renderInvoiceItems(); renderSavedInvoices(); updateStats(); alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!'); } catch(err) { alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù'); } }; reader.readAsText(file); event.target.value = ''; }
        function resetAllData() { if (!confirm('âš ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return; localStorage.removeItem('invoiceAppData'); location.reload(); }

        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
        document.addEventListener('DOMContentLoaded', initApp);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(r => console.log('âœ… SW Ù…Ø³Ø¬Ù„')).catch(e => console.log('SW:', e));
            });
        }
    </script>
</body>
</html>
